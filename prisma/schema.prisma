// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// ============================================
// USER MODEL
// Synced with Clerk authentication
// ============================================
model User {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  clerkId   String   @unique // Clerk user ID
  email     String   @unique
  name      String?
  imageUrl  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  ownedRooms    Room[]            @relation("RoomOwner")
  participants  RoomParticipant[]
  chatMessages  ChatMessage[]

  @@map("users")
}

// ============================================
// ROOM MODEL
// Represents a meeting room with collaboration data
// ============================================
model Room {
  id          String     @id @default(auto()) @map("_id") @db.ObjectId
  code        String     @unique // 6-character room code for joining
  name        String
  description String?
  password    String?    // Optional room password (hashed)
  isActive    Boolean    @default(true)
  status      RoomStatus @default(WAITING)
  
  // Settings
  maxParticipants  Int     @default(50)
  allowChat        Boolean @default(true)
  allowScreenShare Boolean @default(true)
  
  // Collaboration permissions
  whiteboardPermission   String   @default("open")  // 'open' | 'restricted' | 'disabled'
  notesPermission        String   @default("open")  // 'open' | 'restricted' | 'disabled'
  whiteboardAllowedUsers String[] @default([])      // User IDs with explicit whiteboard access
  notesAllowedUsers      String[] @default([])      // User IDs with explicit notes access
  
  // Collaboration data (shared for all participants)
  whiteboardSnapshot Json? // tldraw TLStoreSnapshot
  
  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  startedAt DateTime? // When the meeting started
  endedAt   DateTime? // When the meeting ended

  // Owner relation
  ownerId String @db.ObjectId
  owner   User   @relation("RoomOwner", fields: [ownerId], references: [id])

  // Relations
  participants RoomParticipant[]
  chatMessages ChatMessage[]
  notes        RoomNote[]

  @@index([ownerId])
  @@map("rooms")
}

// ============================================
// ROOM PARTICIPANT MODEL
// Tracks who joined which room and when
// ============================================
model RoomParticipant {
  id       String          @id @default(auto()) @map("_id") @db.ObjectId
  role     ParticipantRole @default(PARTICIPANT)
  joinedAt DateTime        @default(now())
  leftAt   DateTime?

  // Relations
  userId String @db.ObjectId
  user   User   @relation(fields: [userId], references: [id])

  roomId String @db.ObjectId
  room   Room   @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@unique([userId, roomId])
  @@index([roomId])
  @@index([userId])
  @@map("room_participants")
}

// ============================================
// CHAT MESSAGE MODEL
// Persists chat messages for room history
// ============================================
model ChatMessage {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  content   String
  createdAt DateTime @default(now())

  // Relations
  userId String @db.ObjectId
  user   User   @relation(fields: [userId], references: [id])

  roomId String @db.ObjectId
  room   Room   @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@index([roomId])
  @@index([userId])
  @@map("chat_messages")
}

// ============================================
// ROOM NOTE MODEL
// Stores personal notes for each user per room
// Each user has their own notes (not collaborative)
// ============================================
model RoomNote {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  content   Json     // Tiptap JSONContent - personal notes content
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // User who owns these notes (using clerkId for direct lookup)
  clerkUserId String

  // Relations
  roomId String @db.ObjectId
  room   Room   @relation(fields: [roomId], references: [id], onDelete: Cascade)

  // Each user can only have one note per room
  @@unique([roomId, clerkUserId])
  @@index([roomId])
  @@index([clerkUserId])
  @@map("room_notes")
}

// ============================================
// ENUMS
// ============================================
enum RoomStatus {
  WAITING   // Room created, waiting to start
  ACTIVE    // Meeting in progress
  ENDED     // Meeting has ended
}

enum ParticipantRole {
  HOST        // Room owner/creator
  CO_HOST     // Can manage participants
  PARTICIPANT // Regular participant
}
